{% extends 'base.jinja' %}

{% block content %}


<!--Navbar, you'll see the username here-->
<nav style="border-bottom: 1px solid black;">
    <ol style="float: right">
        <li style="display:inline-block">Username:  {{ username }} </li>
    </ol>
</nav>

<h1>Messaging App </h1>
    <h1>Friend List</h1>

        <!-- vardaan's code - implemented click to chat starts here -->
    <section>
        <h2>Current Friends</h2>
        <ul>
            {% for friend in accepted_friends %}
            <li><a href="#" onclick="openChatRoom('{{ friend.username }}')">{{ friend.username }}</a></li>
            {% endfor %}
        </ul>
    </section>
    <!-- vardaan's code - implemented click to chat ends here -->

    <section>
        <h2>Friend Request Inbox</h2>
        <ul>
            {% for request in pending_requests %}
                <li>
                    {{ request.username }}
                    <button onclick="handleFriendRequest('{{ username }}', '{{ request.username }}', true)">Approve</button>
                    <button onclick="handleFriendRequest('{{ username }}', '{{ request.username }}', false)">Reject</button>
                </li>
            {% endfor %}
        </ul>
    </section>

    <section>
        <h2>Pending Friend Requests Awaiting Response...</h2>
        <ul>
            {% for pending in pending_friends %}
                <li>{{ pending.username }}</li>
            {% endfor %}
        </ul>
    </section>

    <script>
        async function handleFriendRequest(loggedInUsername, friendUsername, isAccepted) {
            let actionURL = "{{ url_for('handle_friend_request') }}";
            try {
                let res = await axios.post(actionURL, JSON.stringify({
                    username: loggedInUsername,
                    friend_username: friendUsername,
                    is_accepted: isAccepted
                }), {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (res.data === 'Success') {
                    location.reload();  // Reload the page to update the list
                } else {
                    alert('Error handling the friend request.');
                }
            } catch (error) {
                console.error('Failed to process the friend request:', error);
                alert('Failed to process the friend request.');
            }
        }
    </script>

    <section>
        <h2>Add a New Friend</h2>
        <form id="addFriendForm">
            <input type="text" id="newFriendUsername" placeholder="Enter friend's username" required>
            <button type="button" onclick="addFriend()">Add</button>
        </form>
    </section>

    <script>
        async function addFriend() {
            let username = "{{ username }}";  // Assuming you pass the current user's username as a variable to the template
            let friendUsername = document.getElementById('newFriendUsername').value;
            if(friendUsername) {
                let addURL = "{{ url_for('add_friend') }}";
                try {
                    let res = await axios.post(addURL, JSON.stringify({
                        username: username,
                        friend_username: friendUsername
                    }), {
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    if (res.data === 'Success') {
                        location.reload();  // Reload the page to show the updated friend list
                    } else {
                        alert(res.data.error);  // Correctly display error messages
                    }
                } catch (error) {
                    console.error('Failed to send the friend request:', error);
                    alert('Failed to send the friend request: ' + (error.response.data.error || error.message));
                }
            }
        }
    </script>

    <!--// vardaan's code - implemented click to chat starts here-->
    <script>
    async function openChatRoom(friendUsername) {
    try {
        const startChatURL = "{{ url_for('start_chat') }}";
        const res = await axios.post(startChatURL, JSON.stringify({
            friend_username: friendUsername
        }), {
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (res.data.success) {
            // After successfully setting the session, redirect to the home page
            window.location.href = "{{ url_for('home') }}";
        } else {
            alert('Failed to open chat room.');
        }
    } catch (error) {
        console.error('Error opening chat room:', error);
        alert('Error opening chat room. Please try again.');
    }
}

    </script>
    <!-- vardaan's code - implemented click to chat starts here -->

{% endblock %}
